From 6a0976e83c7f6b19ae6e7adda7986e2cce5ec163 Mon Sep 17 00:00:00 2001
From: Vera Aguilera Puerto <gradientvera@outlook.com>
Date: Mon, 24 Nov 2025 20:49:54 +0100
Subject: [PATCH 1/1] Add ipv6 support for reverse proxy mode

---
 Cargo.lock     | 944 +++++++++++++++++++++++++++++++++++++++++++++++++
 Cargo.toml     |   4 +-
 src/main.rs    | 138 ++++----
 src/mmproxy.rs |  45 +--
 4 files changed, 1043 insertions(+), 88 deletions(-)
 create mode 100644 Cargo.lock

diff --git a/Cargo.lock b/Cargo.lock
new file mode 100644
index 0000000..9999ca2
--- /dev/null
+++ b/Cargo.lock
@@ -0,0 +1,944 @@
+# This file is automatically @generated by Cargo.
+# It is not intended for manual editing.
+version = 4
+
+[[package]]
+name = "android_system_properties"
+version = "0.1.5"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "819e7219dbd41043ac279b19830f2efc897156490d7fd6ea916720117ee66311"
+dependencies = [
+ "libc",
+]
+
+[[package]]
+name = "atty"
+version = "0.2.14"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "d9b39be18770d11421cdb1b9947a45dd3f37e93092cbf377614828a319d5fee8"
+dependencies = [
+ "hermit-abi 0.1.19",
+ "libc",
+ "winapi",
+]
+
+[[package]]
+name = "autocfg"
+version = "1.5.0"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "c08606f8c3cbf4ce6ec8e28fb0014a2c086708fe954eaa885384a6165172e7e8"
+
+[[package]]
+name = "bitflags"
+version = "2.10.0"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "812e12b5285cc515a9c72a5c1d3b6d46a19dac5acfef5265968c166106e31dd3"
+
+[[package]]
+name = "bumpalo"
+version = "3.19.0"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "46c5e41b57b8bba42a04676d81cb89e9ee8e859a1a66f80a5a72e1cb76b34d43"
+
+[[package]]
+name = "bytes"
+version = "1.11.0"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "b35204fbdc0b3f4446b89fc1ac2cf84a8a68971995d0bf2e925ec7cd960f9cb3"
+
+[[package]]
+name = "cc"
+version = "1.2.47"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "cd405d82c84ff7f35739f175f67d8b9fb7687a0e84ccdc78bd3568839827cf07"
+dependencies = [
+ "find-msvc-tools",
+ "shlex",
+]
+
+[[package]]
+name = "cfg-if"
+version = "1.0.4"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "9330f8b2ff13f34540b44e946ef35111825727b38d33286ef986142615121801"
+
+[[package]]
+name = "chrono"
+version = "0.4.42"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "145052bdd345b87320e369255277e3fb5152762ad123a901ef5c262dd38fe8d2"
+dependencies = [
+ "iana-time-zone",
+ "js-sys",
+ "num-traits",
+ "wasm-bindgen",
+ "windows-link",
+]
+
+[[package]]
+name = "colored"
+version = "2.2.0"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "117725a109d387c937a1533ce01b450cbde6b88abceea8473c4d7a85853cda3c"
+dependencies = [
+ "lazy_static",
+ "windows-sys 0.59.0",
+]
+
+[[package]]
+name = "core-foundation-sys"
+version = "0.8.7"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "773648b94d0e5d620f64f280777445740e61fe701025087ec8b57f45c791888b"
+
+[[package]]
+name = "deranged"
+version = "0.5.5"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "ececcb659e7ba858fb4f10388c250a7252eb0a27373f1a72b8748afdd248e587"
+dependencies = [
+ "powerfmt",
+]
+
+[[package]]
+name = "doc-comment"
+version = "0.3.4"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "780955b8b195a21ab8e4ac6b60dd1dbdcec1dc6c51c0617964b08c81785e12c9"
+
+[[package]]
+name = "find-msvc-tools"
+version = "0.1.5"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "3a3076410a55c90011c298b04d0cfa770b00fa04e1e3c97d3f6c9de105a03844"
+
+[[package]]
+name = "getopts"
+version = "0.2.24"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "cfe4fbac503b8d1f88e6676011885f34b7174f46e59956bba534ba83abded4df"
+dependencies = [
+ "unicode-width",
+]
+
+[[package]]
+name = "getrandom"
+version = "0.2.16"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "335ff9f135e4384c8150d6f27c6daed433577f86b4750418338c01a1a2528592"
+dependencies = [
+ "cfg-if",
+ "libc",
+ "wasi",
+]
+
+[[package]]
+name = "hermit-abi"
+version = "0.1.19"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "62b467343b94ba476dcb2500d242dadbb39557df889310ac77c5d99100aaac33"
+dependencies = [
+ "libc",
+]
+
+[[package]]
+name = "hermit-abi"
+version = "0.5.2"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "fc0fef456e4baa96da950455cd02c081ca953b141298e41db3fc7e36b1da849c"
+
+[[package]]
+name = "iana-time-zone"
+version = "0.1.64"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "33e57f83510bb73707521ebaffa789ec8caf86f9657cad665b092b581d40e9fb"
+dependencies = [
+ "android_system_properties",
+ "core-foundation-sys",
+ "iana-time-zone-haiku",
+ "js-sys",
+ "log",
+ "wasm-bindgen",
+ "windows-core",
+]
+
+[[package]]
+name = "iana-time-zone-haiku"
+version = "0.1.2"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "f31827a206f56af32e590ba56d5d2d085f558508192593743f16b2306495269f"
+dependencies = [
+ "cc",
+]
+
+[[package]]
+name = "itoa"
+version = "1.0.15"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "4a5f13b858c8d314ee3e8f639011f7ccefe71f97f96e50151fb991f267928e2c"
+
+[[package]]
+name = "js-sys"
+version = "0.3.82"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "b011eec8cc36da2aab2d5cff675ec18454fad408585853910a202391cf9f8e65"
+dependencies = [
+ "once_cell",
+ "wasm-bindgen",
+]
+
+[[package]]
+name = "lazy_static"
+version = "1.5.0"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "bbd2bcb4c963f2ddae06a2efc7e9f3591312473c50c6685e1f298068316e66fe"
+
+[[package]]
+name = "libc"
+version = "0.2.177"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "2874a2af47a2325c2001a6e6fad9b16a53b802102b528163885171cf92b15976"
+
+[[package]]
+name = "libmimalloc-sys"
+version = "0.1.44"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "667f4fec20f29dfc6bc7357c582d91796c169ad7e2fce709468aefeb2c099870"
+dependencies = [
+ "cc",
+ "libc",
+]
+
+[[package]]
+name = "lock_api"
+version = "0.4.14"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "224399e74b87b5f3557511d98dff8b14089b3dadafcab6bb93eab67d3aace965"
+dependencies = [
+ "scopeguard",
+]
+
+[[package]]
+name = "log"
+version = "0.4.28"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "34080505efa8e45a4b816c349525ebe327ceaa8559756f0356cba97ef3bf7432"
+
+[[package]]
+name = "mimalloc"
+version = "0.1.48"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "e1ee66a4b64c74f4ef288bcbb9192ad9c3feaad75193129ac8509af543894fd8"
+dependencies = [
+ "libmimalloc-sys",
+]
+
+[[package]]
+name = "mio"
+version = "1.1.0"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "69d83b0086dc8ecf3ce9ae2874b2d1290252e2a30720bea58a5c6639b0092873"
+dependencies = [
+ "libc",
+ "wasi",
+ "windows-sys 0.61.2",
+]
+
+[[package]]
+name = "num-conv"
+version = "0.1.0"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "51d515d32fb182ee37cda2ccdcb92950d6a3c2893aa280e540671c2cd0f3b1d9"
+
+[[package]]
+name = "num-traits"
+version = "0.2.19"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "071dfc062690e90b734c0b2273ce72ad0ffa95f0c74596bc250dcfd960262841"
+dependencies = [
+ "autocfg",
+]
+
+[[package]]
+name = "num_cpus"
+version = "1.17.0"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "91df4bbde75afed763b708b7eee1e8e7651e02d97f6d5dd763e89367e957b23b"
+dependencies = [
+ "hermit-abi 0.5.2",
+ "libc",
+]
+
+[[package]]
+name = "num_threads"
+version = "0.1.7"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "5c7398b9c8b70908f6371f47ed36737907c87c52af34c268fed0bf0ceb92ead9"
+dependencies = [
+ "libc",
+]
+
+[[package]]
+name = "once_cell"
+version = "1.21.3"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "42f5e15c9953c5e4ccceeb2e7382a716482c34515315f7b03532b8b4e8393d2d"
+
+[[package]]
+name = "os_socketaddr"
+version = "0.2.5"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "fa149f3ec09cadeb41968390fcd71e6ea038a9a373d1d4eb070f4d9484d4b244"
+dependencies = [
+ "libc",
+ "winapi",
+]
+
+[[package]]
+name = "parking_lot"
+version = "0.12.5"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "93857453250e3077bd71ff98b6a65ea6621a19bb0f559a85248955ac12c45a1a"
+dependencies = [
+ "lock_api",
+ "parking_lot_core",
+]
+
+[[package]]
+name = "parking_lot_core"
+version = "0.9.12"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "2621685985a2ebf1c516881c026032ac7deafcda1a2c9b7850dc81e3dfcb64c1"
+dependencies = [
+ "cfg-if",
+ "libc",
+ "redox_syscall",
+ "smallvec",
+ "windows-link",
+]
+
+[[package]]
+name = "pin-project-lite"
+version = "0.2.16"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "3b3cff922bd51709b605d9ead9aa71031d81447142d828eb4a6eba76fe619f9b"
+
+[[package]]
+name = "powerfmt"
+version = "0.2.0"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "439ee305def115ba05938db6eb1644ff94165c5ab5e9420d1c1bcedbba909391"
+
+[[package]]
+name = "ppv-lite86"
+version = "0.2.21"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "85eae3c4ed2f50dcfe72643da4befc30deadb458a9b590d720cde2f2b1e97da9"
+dependencies = [
+ "zerocopy",
+]
+
+[[package]]
+name = "proc-macro2"
+version = "1.0.103"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "5ee95bc4ef87b8d5ba32e8b7714ccc834865276eab0aed5c9958d00ec45f49e8"
+dependencies = [
+ "unicode-ident",
+]
+
+[[package]]
+name = "proxy-protocol"
+version = "0.5.0"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "0e50c72c21c738f5c5f350cc33640aee30bf7cd20f9d9da20ed41bce2671d532"
+dependencies = [
+ "bytes",
+ "snafu",
+]
+
+[[package]]
+name = "quote"
+version = "1.0.42"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "a338cc41d27e6cc6dce6cefc13a0729dfbb81c262b1f519331575dd80ef3067f"
+dependencies = [
+ "proc-macro2",
+]
+
+[[package]]
+name = "rand"
+version = "0.8.5"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "34af8d1a0e25924bc5b7c43c079c942339d8f0a8b57c39049bef581b46327404"
+dependencies = [
+ "libc",
+ "rand_chacha",
+ "rand_core",
+]
+
+[[package]]
+name = "rand_chacha"
+version = "0.3.1"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "e6c10a63a0fa32252be49d21e7709d4d4baf8d231c2dbce1eaa8141b9b127d88"
+dependencies = [
+ "ppv-lite86",
+ "rand_core",
+]
+
+[[package]]
+name = "rand_core"
+version = "0.6.4"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "ec0be4795e2f6a28069bec0b5ff3e2ac9bafc99e6a9a7dc3547996c5c816922c"
+dependencies = [
+ "getrandom",
+]
+
+[[package]]
+name = "redox_syscall"
+version = "0.5.18"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "ed2bf2547551a7053d6fdfafda3f938979645c44812fbfcda098faae3f1a362d"
+dependencies = [
+ "bitflags",
+]
+
+[[package]]
+name = "rustversion"
+version = "1.0.22"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "b39cdef0fa800fc44525c84ccb54a029961a8215f9619753635a9c0d2538d46d"
+
+[[package]]
+name = "scopeguard"
+version = "1.2.0"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "94143f37725109f92c262ed2cf5e59bce7498c01bcc1502d7b9afe439a4e9f49"
+
+[[package]]
+name = "serde"
+version = "1.0.228"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "9a8e94ea7f378bd32cbbd37198a4a91436180c5bb472411e48b5ec2e2124ae9e"
+dependencies = [
+ "serde_core",
+]
+
+[[package]]
+name = "serde_core"
+version = "1.0.228"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "41d385c7d4ca58e59fc732af25c3983b67ac852c1a25000afe1175de458b67ad"
+dependencies = [
+ "serde_derive",
+]
+
+[[package]]
+name = "serde_derive"
+version = "1.0.228"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "d540f220d3187173da220f885ab66608367b6574e925011a9353e4badda91d79"
+dependencies = [
+ "proc-macro2",
+ "quote",
+ "syn 2.0.111",
+]
+
+[[package]]
+name = "shlex"
+version = "1.3.0"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "0fda2ff0d084019ba4d7c6f371c95d8fd75ce3524c3cb8fb653a3023f6323e64"
+
+[[package]]
+name = "signal-hook-registry"
+version = "1.4.7"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "7664a098b8e616bdfcc2dc0e9ac44eb231eedf41db4e9fe95d8d32ec728dedad"
+dependencies = [
+ "libc",
+]
+
+[[package]]
+name = "simple_logger"
+version = "2.3.0"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "48047e77b528151aaf841a10a9025f9459da80ba820e425ff7eb005708a76dc7"
+dependencies = [
+ "atty",
+ "colored",
+ "log",
+ "time",
+ "winapi",
+]
+
+[[package]]
+name = "smallvec"
+version = "1.15.1"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "67b1b7a3b5fe4f1376887184045fcf45c69e92af734b7aaddc05fb777b6fbd03"
+
+[[package]]
+name = "snafu"
+version = "0.6.10"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "eab12d3c261b2308b0d80c26fffb58d17eba81a4be97890101f416b478c79ca7"
+dependencies = [
+ "doc-comment",
+ "snafu-derive",
+]
+
+[[package]]
+name = "snafu-derive"
+version = "0.6.10"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "1508efa03c362e23817f96cde18abed596a25219a8b2c66e8db33c03543d315b"
+dependencies = [
+ "proc-macro2",
+ "quote",
+ "syn 1.0.109",
+]
+
+[[package]]
+name = "socket2"
+version = "0.6.1"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "17129e116933cf371d018bb80ae557e889637989d8638274fb25622827b03881"
+dependencies = [
+ "libc",
+ "windows-sys 0.60.2",
+]
+
+[[package]]
+name = "syn"
+version = "1.0.109"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "72b64191b275b66ffe2469e8af2c1cfe3bafa67b529ead792a6d0160888b4237"
+dependencies = [
+ "proc-macro2",
+ "quote",
+ "unicode-ident",
+]
+
+[[package]]
+name = "syn"
+version = "2.0.111"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "390cc9a294ab71bdb1aa2e99d13be9c753cd2d7bd6560c77118597410c4d2e87"
+dependencies = [
+ "proc-macro2",
+ "quote",
+ "unicode-ident",
+]
+
+[[package]]
+name = "time"
+version = "0.3.44"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "91e7d9e3bb61134e77bde20dd4825b97c010155709965fedf0f49bb138e52a9d"
+dependencies = [
+ "deranged",
+ "itoa",
+ "libc",
+ "num-conv",
+ "num_threads",
+ "powerfmt",
+ "serde",
+ "time-core",
+ "time-macros",
+]
+
+[[package]]
+name = "time-core"
+version = "0.1.6"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "40868e7c1d2f0b8d73e4a8c7f0ff63af4f6d19be117e90bd73eb1d62cf831c6b"
+
+[[package]]
+name = "time-macros"
+version = "0.2.24"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "30cfb0125f12d9c277f35663a0a33f8c30190f4e4574868a330595412d34ebf3"
+dependencies = [
+ "num-conv",
+ "time-core",
+]
+
+[[package]]
+name = "tokio"
+version = "1.48.0"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "ff360e02eab121e0bc37a2d3b4d4dc622e6eda3a8e5253d5435ecf5bd4c68408"
+dependencies = [
+ "bytes",
+ "libc",
+ "mio",
+ "parking_lot",
+ "pin-project-lite",
+ "signal-hook-registry",
+ "socket2",
+ "tokio-macros",
+ "windows-sys 0.61.2",
+]
+
+[[package]]
+name = "tokio-macros"
+version = "2.6.0"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "af407857209536a95c8e56f8231ef2c2e2aff839b22e07a1ffcbc617e9db9fa5"
+dependencies = [
+ "proc-macro2",
+ "quote",
+ "syn 2.0.111",
+]
+
+[[package]]
+name = "udp_sas"
+version = "0.1.4"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "739982f0257c531a6c4301aa069c268119e1c9de42e3655742ff292177272d0e"
+dependencies = [
+ "cc",
+ "libc",
+ "os_socketaddr",
+]
+
+[[package]]
+name = "udppp"
+version = "0.4.0"
+dependencies = [
+ "bytes",
+ "chrono",
+ "getopts",
+ "log",
+ "mimalloc",
+ "num_cpus",
+ "proxy-protocol",
+ "rand",
+ "simple_logger",
+ "socket2",
+ "tokio",
+ "udp_sas",
+]
+
+[[package]]
+name = "unicode-ident"
+version = "1.0.22"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "9312f7c4f6ff9069b165498234ce8be658059c6728633667c526e27dc2cf1df5"
+
+[[package]]
+name = "unicode-width"
+version = "0.2.2"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "b4ac048d71ede7ee76d585517add45da530660ef4390e49b098733c6e897f254"
+
+[[package]]
+name = "wasi"
+version = "0.11.1+wasi-snapshot-preview1"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "ccf3ec651a847eb01de73ccad15eb7d99f80485de043efb2f370cd654f4ea44b"
+
+[[package]]
+name = "wasm-bindgen"
+version = "0.2.105"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "da95793dfc411fbbd93f5be7715b0578ec61fe87cb1a42b12eb625caa5c5ea60"
+dependencies = [
+ "cfg-if",
+ "once_cell",
+ "rustversion",
+ "wasm-bindgen-macro",
+ "wasm-bindgen-shared",
+]
+
+[[package]]
+name = "wasm-bindgen-macro"
+version = "0.2.105"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "04264334509e04a7bf8690f2384ef5265f05143a4bff3889ab7a3269adab59c2"
+dependencies = [
+ "quote",
+ "wasm-bindgen-macro-support",
+]
+
+[[package]]
+name = "wasm-bindgen-macro-support"
+version = "0.2.105"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "420bc339d9f322e562942d52e115d57e950d12d88983a14c79b86859ee6c7ebc"
+dependencies = [
+ "bumpalo",
+ "proc-macro2",
+ "quote",
+ "syn 2.0.111",
+ "wasm-bindgen-shared",
+]
+
+[[package]]
+name = "wasm-bindgen-shared"
+version = "0.2.105"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "76f218a38c84bcb33c25ec7059b07847d465ce0e0a76b995e134a45adcb6af76"
+dependencies = [
+ "unicode-ident",
+]
+
+[[package]]
+name = "winapi"
+version = "0.3.9"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "5c839a674fcd7a98952e593242ea400abe93992746761e38641405d28b00f419"
+dependencies = [
+ "winapi-i686-pc-windows-gnu",
+ "winapi-x86_64-pc-windows-gnu",
+]
+
+[[package]]
+name = "winapi-i686-pc-windows-gnu"
+version = "0.4.0"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "ac3b87c63620426dd9b991e5ce0329eff545bccbbb34f3be09ff6fb6ab51b7b6"
+
+[[package]]
+name = "winapi-x86_64-pc-windows-gnu"
+version = "0.4.0"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "712e227841d057c1ee1cd2fb22fa7e5a5461ae8e48fa2ca79ec42cfc1931183f"
+
+[[package]]
+name = "windows-core"
+version = "0.62.2"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "b8e83a14d34d0623b51dce9581199302a221863196a1dde71a7663a4c2be9deb"
+dependencies = [
+ "windows-implement",
+ "windows-interface",
+ "windows-link",
+ "windows-result",
+ "windows-strings",
+]
+
+[[package]]
+name = "windows-implement"
+version = "0.60.2"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "053e2e040ab57b9dc951b72c264860db7eb3b0200ba345b4e4c3b14f67855ddf"
+dependencies = [
+ "proc-macro2",
+ "quote",
+ "syn 2.0.111",
+]
+
+[[package]]
+name = "windows-interface"
+version = "0.59.3"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "3f316c4a2570ba26bbec722032c4099d8c8bc095efccdc15688708623367e358"
+dependencies = [
+ "proc-macro2",
+ "quote",
+ "syn 2.0.111",
+]
+
+[[package]]
+name = "windows-link"
+version = "0.2.1"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "f0805222e57f7521d6a62e36fa9163bc891acd422f971defe97d64e70d0a4fe5"
+
+[[package]]
+name = "windows-result"
+version = "0.4.1"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "7781fa89eaf60850ac3d2da7af8e5242a5ea78d1a11c49bf2910bb5a73853eb5"
+dependencies = [
+ "windows-link",
+]
+
+[[package]]
+name = "windows-strings"
+version = "0.5.1"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "7837d08f69c77cf6b07689544538e017c1bfcf57e34b4c0ff58e6c2cd3b37091"
+dependencies = [
+ "windows-link",
+]
+
+[[package]]
+name = "windows-sys"
+version = "0.59.0"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "1e38bc4d79ed67fd075bcc251a1c39b32a1776bbe92e5bef1f0bf1f8c531853b"
+dependencies = [
+ "windows-targets 0.52.6",
+]
+
+[[package]]
+name = "windows-sys"
+version = "0.60.2"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "f2f500e4d28234f72040990ec9d39e3a6b950f9f22d3dba18416c35882612bcb"
+dependencies = [
+ "windows-targets 0.53.5",
+]
+
+[[package]]
+name = "windows-sys"
+version = "0.61.2"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "ae137229bcbd6cdf0f7b80a31df61766145077ddf49416a728b02cb3921ff3fc"
+dependencies = [
+ "windows-link",
+]
+
+[[package]]
+name = "windows-targets"
+version = "0.52.6"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "9b724f72796e036ab90c1021d4780d4d3d648aca59e491e6b98e725b84e99973"
+dependencies = [
+ "windows_aarch64_gnullvm 0.52.6",
+ "windows_aarch64_msvc 0.52.6",
+ "windows_i686_gnu 0.52.6",
+ "windows_i686_gnullvm 0.52.6",
+ "windows_i686_msvc 0.52.6",
+ "windows_x86_64_gnu 0.52.6",
+ "windows_x86_64_gnullvm 0.52.6",
+ "windows_x86_64_msvc 0.52.6",
+]
+
+[[package]]
+name = "windows-targets"
+version = "0.53.5"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "4945f9f551b88e0d65f3db0bc25c33b8acea4d9e41163edf90dcd0b19f9069f3"
+dependencies = [
+ "windows-link",
+ "windows_aarch64_gnullvm 0.53.1",
+ "windows_aarch64_msvc 0.53.1",
+ "windows_i686_gnu 0.53.1",
+ "windows_i686_gnullvm 0.53.1",
+ "windows_i686_msvc 0.53.1",
+ "windows_x86_64_gnu 0.53.1",
+ "windows_x86_64_gnullvm 0.53.1",
+ "windows_x86_64_msvc 0.53.1",
+]
+
+[[package]]
+name = "windows_aarch64_gnullvm"
+version = "0.52.6"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "32a4622180e7a0ec044bb555404c800bc9fd9ec262ec147edd5989ccd0c02cd3"
+
+[[package]]
+name = "windows_aarch64_gnullvm"
+version = "0.53.1"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "a9d8416fa8b42f5c947f8482c43e7d89e73a173cead56d044f6a56104a6d1b53"
+
+[[package]]
+name = "windows_aarch64_msvc"
+version = "0.52.6"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "09ec2a7bb152e2252b53fa7803150007879548bc709c039df7627cabbd05d469"
+
+[[package]]
+name = "windows_aarch64_msvc"
+version = "0.53.1"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "b9d782e804c2f632e395708e99a94275910eb9100b2114651e04744e9b125006"
+
+[[package]]
+name = "windows_i686_gnu"
+version = "0.52.6"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "8e9b5ad5ab802e97eb8e295ac6720e509ee4c243f69d781394014ebfe8bbfa0b"
+
+[[package]]
+name = "windows_i686_gnu"
+version = "0.53.1"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "960e6da069d81e09becb0ca57a65220ddff016ff2d6af6a223cf372a506593a3"
+
+[[package]]
+name = "windows_i686_gnullvm"
+version = "0.52.6"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "0eee52d38c090b3caa76c563b86c3a4bd71ef1a819287c19d586d7334ae8ed66"
+
+[[package]]
+name = "windows_i686_gnullvm"
+version = "0.53.1"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "fa7359d10048f68ab8b09fa71c3daccfb0e9b559aed648a8f95469c27057180c"
+
+[[package]]
+name = "windows_i686_msvc"
+version = "0.52.6"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "240948bc05c5e7c6dabba28bf89d89ffce3e303022809e73deaefe4f6ec56c66"
+
+[[package]]
+name = "windows_i686_msvc"
+version = "0.53.1"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "1e7ac75179f18232fe9c285163565a57ef8d3c89254a30685b57d83a38d326c2"
+
+[[package]]
+name = "windows_x86_64_gnu"
+version = "0.52.6"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "147a5c80aabfbf0c7d901cb5895d1de30ef2907eb21fbbab29ca94c5b08b1a78"
+
+[[package]]
+name = "windows_x86_64_gnu"
+version = "0.53.1"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "9c3842cdd74a865a8066ab39c8a7a473c0778a3f29370b5fd6b4b9aa7df4a499"
+
+[[package]]
+name = "windows_x86_64_gnullvm"
+version = "0.52.6"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "24d5b23dc417412679681396f2b49f3de8c1473deb516bd34410872eff51ed0d"
+
+[[package]]
+name = "windows_x86_64_gnullvm"
+version = "0.53.1"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "0ffa179e2d07eee8ad8f57493436566c7cc30ac536a3379fdf008f47f6bb7ae1"
+
+[[package]]
+name = "windows_x86_64_msvc"
+version = "0.52.6"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "589f6da84c646204747d1270a2a5661ea66ed1cced2631d546fdfb155959f9ec"
+
+[[package]]
+name = "windows_x86_64_msvc"
+version = "0.53.1"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "d6bbff5f0aada427a1e5a6da5f1f98158182f26556f345ac9e04d36d0ebed650"
+
+[[package]]
+name = "zerocopy"
+version = "0.8.28"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "43fa6694ed34d6e57407afbccdeecfa268c470a7d2a5b0cf49ce9fcc345afb90"
+dependencies = [
+ "zerocopy-derive",
+]
+
+[[package]]
+name = "zerocopy-derive"
+version = "0.8.28"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "c640b22cd9817fae95be82f0d2f90b11f7605f6c319d16705c459b27ac2cbc26"
+dependencies = [
+ "proc-macro2",
+ "quote",
+ "syn 2.0.111",
+]
diff --git a/Cargo.toml b/Cargo.toml
index 327735d..102c9ce 100644
--- a/Cargo.toml
+++ b/Cargo.toml
@@ -19,7 +19,7 @@ proxy-protocol = "0.5.0"
 chrono = "0.4.19"
 udp_sas = "0.1.3"
 bytes = "1.1.0"
-net2 = "0.2.37"
 tokio = { version = "1", features = ["full"] }
 num_cpus = "1.13.1"
-mimalloc = "0.1.28"
\ No newline at end of file
+mimalloc = "0.1.28"
+socket2 = "0.6.1"
diff --git a/src/main.rs b/src/main.rs
index ff44851..bf5e231 100644
--- a/src/main.rs
+++ b/src/main.rs
@@ -1,20 +1,18 @@
 use getopts::Options;
 use log::{LevelFilter};
-use net2::{UdpBuilder};
-use net2::unix::{UnixUdpBuilderExt};
 use simple_logger::SimpleLogger;
+use socket2::{SockAddr, SockRef};
 use tokio::net::UdpSocket;
-use tokio::runtime::{Builder, Runtime};
-use tokio::sync::Mutex;
-use tokio::sync::mpsc::unbounded_channel;
+use tokio::runtime::Builder;
+use tokio::sync::{Mutex, mpsc};
 use tokio::time::timeout;
 use std::collections::HashMap;
 use std::time::Duration;
 use std::{env};
-use std::net::{SocketAddrV4, SocketAddr};
+use std::net::{Ipv4Addr, Ipv6Addr, SocketAddr, SocketAddrV4, SocketAddrV6};
 use std::sync::{Arc};
 use proxy_protocol::{version2, ProxyHeader};
-use tokio::{self, select};
+use tokio;
 mod utils;
 use utils::*;
 mod mmproxy;
@@ -33,7 +31,8 @@ fn print_usage(program: &str, opts: Options) {
     print!("{}", opts.usage(&brief));
 }
 
-fn main() {
+#[tokio::main]
+async fn main() {
 	SimpleLogger::new().with_colors(true).init().unwrap();
 	::log::set_max_level(LevelFilter::Info);
 
@@ -67,7 +66,7 @@ fn main() {
                 "proxyprotocol",
                 "enable proxy-protocol");
     opts.optflag("s",
-                "slient",
+                "silent",
                 "disable print log");
 
     let matches = opts.parse(&args[1..])
@@ -78,8 +77,8 @@ fn main() {
     
     let enable_proxy_protocol = matches.opt_present("p");
     let mode: u32 = matches.opt_str("m").unwrap().parse().unwrap();
-    let local_port: u32 = matches.opt_str("l").unwrap().parse().unwrap();
-    let remote_port: u32 = matches.opt_str("r").unwrap().parse().unwrap();
+    let local_port: u16 = matches.opt_str("l").unwrap().parse().unwrap();
+    let remote_port: u16 = matches.opt_str("r").unwrap().parse().unwrap();
     let remote_host = matches.opt_str("h").unwrap();
     let bind_addr = match matches.opt_str("b") {
         Some(addr) => addr,
@@ -90,27 +89,15 @@ fn main() {
         ::log::set_max_level(LevelFilter::Off);
     }
 
-    let mut cpus = num_cpus::get();
-
-    let mut workers = vec![];
-
-    if mode == 1{
-
-        while cpus != 0 {
-            let bind_addr = bind_addr.clone();
-            let remote_host = remote_host.clone();
-            workers.push(std::thread::spawn(move || {
-                let rt = Builder::new_current_thread().enable_all().build().unwrap();
-                rt.block_on(forward(&bind_addr, local_port, &remote_host, remote_port , enable_proxy_protocol, &rt ));
-            }));
-            cpus -= 1;
-        }
-
-        for _ in 0..workers.len() {
-            workers.pop().unwrap().join().unwrap();
-        }
-
-    } else if mode == 2{
+    if mode == 1 {
+        let bind_addr = bind_addr.clone();
+        let remote_host = remote_host.clone();
+        let a = tokio::spawn(listen_forward(bind_addr.clone(), local_port, remote_host.clone(), remote_port , enable_proxy_protocol));
+        a.await.unwrap();
+        
+    } else if mode == 2 {
+        let mut cpus = num_cpus::get();
+        let mut workers = vec![];
 
         while cpus != 0 {
             let bind_addr = bind_addr.clone();
@@ -131,23 +118,18 @@ fn main() {
     }
 }
 
-async fn forward(bind_addr: &str, local_port: u32, remote_host: &str, remote_port: u32 , enable_proxy_protocol : bool , rt : &Runtime) {
-
-    let local_addr = format!("{}:{}", bind_addr, local_port);
-    let local_socket = match UdpBuilder::new_v4().unwrap()
-        .reuse_address(true).unwrap()
-        .reuse_port(true).unwrap()
-        .bind(local_addr.clone()) {
-            Ok(p) => p,
-            Err(_) => {
-                log::error!("listen to {} faild!" , local_addr);
-                return;
-            },
-        };
-    local_socket.set_nonblocking(true).unwrap();
-    let local_socket = UdpSocket::from_std(local_socket).unwrap();
+async fn listen_forward(bind_addr: String, local_port: u16, remote_host: String, remote_port: u16 , enable_proxy_protocol : bool) {
+    let local_addr: SocketAddr = format!("{}:{}", bind_addr, local_port).parse().unwrap();
+    let local_socket = {
+        let socket = UdpSocket::bind(local_addr).await.unwrap();
 
-    log::info!("listen to {}" , local_addr);
+        let sock_ref = SockRef::from(&socket);
+        sock_ref.set_reuse_port(true).unwrap();
+        sock_ref.set_reuse_address(true).unwrap();
+        sock_ref.set_nonblocking(true).unwrap();
+
+        Arc::new(socket)
+    };
 
     if enable_proxy_protocol {
         log::info!("enable proxy-protocol");
@@ -155,17 +137,19 @@ async fn forward(bind_addr: &str, local_port: u32, remote_host: &str, remote_por
 
     let remote_addr = format!("{}:{}", remote_host, remote_port);
 
-    let mut buf = [0; 64 * 1024];
+    let mut buffer = [0u8; (64 * 1024)];
 
-    let ( c_send , mut c_recv) = unbounded_channel::<(SocketAddr, Vec<u8>)>();
-
-    let send_lck = Arc::new(Mutex::new(c_send));
+    let ( tx , mut rx) = mpsc::unbounded_channel::<(SocketAddr, Vec<u8>)>();
+    
+    let send_lck = Arc::new(Mutex::new(tx));
 
     let socket_addr_map: Arc<Mutex<HashMap<SocketAddr , (Arc<UdpSocket>, i64)>>> = Arc::new(Mutex::new(HashMap::new()));
 
+    log::info!("listen on {}" , local_addr);
+
     loop{
-        select! {
-            a = local_socket.recv_from(&mut buf) => {
+        tokio::select! {
+            a = local_socket.recv_from(&mut buffer) => {
                 let mut socket_addr_map_lck = socket_addr_map.lock().await;
                 let (size, src_addr) = a.unwrap();
                 let mut old_stream = false;
@@ -187,29 +171,55 @@ async fn forward(bind_addr: &str, local_port: u32, remote_host: &str, remote_por
                 log::info!("send to upstream [{}] size : {} " , remote_addr , size);
 
                 if enable_proxy_protocol {
-                    let srcaddr : SocketAddrV4 = src_addr.to_string().as_str().parse().unwrap();
-                    let dstaddr : SocketAddrV4 = local_socket.local_addr().unwrap().to_string().as_str().parse().unwrap();
+                    
+                    let pp_addresses: version2::ProxyAddresses = match src_addr {
+                        SocketAddr::V4(_) => {
+                            let srcaddr4 : SocketAddrV4 = src_addr.to_string().as_str().parse().unwrap();
+                            let dstaddr4 : SocketAddrV4 = local_socket.local_addr().unwrap().to_string().as_str().parse().unwrap();
+                            version2::ProxyAddresses::Ipv4 {
+                                source: srcaddr4,
+                                destination: dstaddr4
+                            }
+                        },
+                        SocketAddr::V6(src_addr6) => {
+                            // Ipv4-mapped
+                            if let Some(mapped) = src_addr6.ip().to_ipv4() {
+                                let srcaddr4 : SocketAddrV4 = SocketAddrV4::new(mapped, local_port);
+                                let dstaddr4 : SocketAddrV4 = SocketAddrV4::new(Ipv4Addr::UNSPECIFIED, local_port);
+                                version2::ProxyAddresses::Ipv4 {
+                                    source: srcaddr4,
+                                    destination: dstaddr4
+                                }
+                            } else {
+                                let srcaddr6 : SocketAddrV6 = src_addr.to_string().as_str().parse().unwrap();
+                                let dstaddr6 : SocketAddrV6 = local_socket.local_addr().unwrap().to_string().as_str().parse().unwrap();
+                                version2::ProxyAddresses::Ipv6 {
+                                    source: srcaddr6,
+                                    destination: dstaddr6
+                                }
+                            }
+
+
+                        },
+                    };
                     let pp_header = ProxyHeader::Version2 {
                         command: version2::ProxyCommand::Proxy,
-                        addresses: version2::ProxyAddresses::Ipv4 {
-                            source: srcaddr,
-                            destination: dstaddr
-                        },
+                        addresses: pp_addresses,
                         transport_protocol: version2::ProxyTransportProtocol::Datagram,
                     };
                     let ori_pp_header = proxy_protocol::encode(pp_header).unwrap();
                     let mut pp_buf = ori_pp_header.to_vec();
-                    pp_buf.append(&mut buf[..size].to_vec());
+                    pp_buf.append(&mut buffer[..size].to_vec());
         
                     upstream.send_to(pp_buf.as_slice(), &remote_addr).await.unwrap();
                 } else {
-                    upstream.send_to(&buf[..size].to_vec(), &remote_addr).await.unwrap();
+                    upstream.send_to(&buffer[..size].to_vec(), &remote_addr).await.unwrap();
                 }
         
                 if ! old_stream {
                     let send_lck = send_lck.clone();
                     let socket_addr_map_in_worker_lck = socket_addr_map.clone();
-                    rt.spawn(async move {
+                    tokio::spawn(async move {
                         let mut buf = [0; 64 * 1024];
                         loop{
                             match timeout(Duration::from_secs(TIMEOUT_SECOND) ,upstream.recv_from(&mut buf)).await{
@@ -231,7 +241,7 @@ async fn forward(bind_addr: &str, local_port: u32, remote_host: &str, remote_por
                     });
                 } 
             },
-            b = c_recv.recv() => {
+            b = rx.recv() => {
                 let (src_addr , data) = b.unwrap();
                 local_socket.send_to(data.as_slice() , src_addr).await.unwrap();
             }
diff --git a/src/mmproxy.rs b/src/mmproxy.rs
index 1b68498..14dfbab 100644
--- a/src/mmproxy.rs
+++ b/src/mmproxy.rs
@@ -1,7 +1,7 @@
 use std::{net::{SocketAddr, SocketAddrV4, IpAddr}, io::{Error, ErrorKind}, time::Duration};
 use std::sync::{Arc};
-use net2::{UdpBuilder, unix::UnixUdpBuilderExt};
 use proxy_protocol::parse;
+use socket2::SockRef;
 use tokio::{net::UdpSocket, sync::{Mutex, mpsc::unbounded_channel}, select, runtime::Runtime, time::timeout};
 use udp_sas::UdpSas;
 use std::collections::HashMap;
@@ -15,23 +15,23 @@ fn parse_proxy_protocol(mut buf : &[u8]) -> Result<(SocketAddrV4 , &[u8]), Error
             match p{
                 proxy_protocol::ProxyHeader::Version1 { addresses } => {
                     match addresses{
-                        proxy_protocol::version1::ProxyAddresses::Unknown => Err(Error::new(ErrorKind::Other,"parse faild")),
+                        proxy_protocol::version1::ProxyAddresses::Unknown => Err(Error::new(ErrorKind::Other,"parse failed")),
                         proxy_protocol::version1::ProxyAddresses::Ipv4 { source, destination : _ } => Ok(source),
-                        proxy_protocol::version1::ProxyAddresses::Ipv6 { source: _, destination : _ } => Err(Error::new(ErrorKind::Other,"parse faild")),
+                        proxy_protocol::version1::ProxyAddresses::Ipv6 { source: _, destination : _ } => Err(Error::new(ErrorKind::Other,"parse failed")),
                     }
                 },
                 proxy_protocol::ProxyHeader::Version2 { command : _, transport_protocol : _, addresses } => {
                     match addresses{
-                        proxy_protocol::version2::ProxyAddresses::Unspec => Err(Error::new(ErrorKind::Other,"parse faild")),
+                        proxy_protocol::version2::ProxyAddresses::Unspec => Err(Error::new(ErrorKind::Other,"parse failed")),
                         proxy_protocol::version2::ProxyAddresses::Ipv4 { source, destination : _ } => Ok(source),
-                        proxy_protocol::version2::ProxyAddresses::Ipv6 { source : _, destination : _ } => Err(Error::new(ErrorKind::Other,"parse faild")),
-                        proxy_protocol::version2::ProxyAddresses::Unix { source : _, destination : _ } => Err(Error::new(ErrorKind::Other,"parse faild")),
+                        proxy_protocol::version2::ProxyAddresses::Ipv6 { source : _, destination : _ } => Err(Error::new(ErrorKind::Other,"parse failed")),
+                        proxy_protocol::version2::ProxyAddresses::Unix { source : _, destination : _ } => Err(Error::new(ErrorKind::Other,"parse failed")),
                     }
                 },
-                _ => Err(Error::new(ErrorKind::Other,"parse faild"))
+                _ => Err(Error::new(ErrorKind::Other,"parse failed"))
             }
         },
-        Err(_) => Err(Error::new(ErrorKind::Other,"parse faild"))
+        Err(_) => Err(Error::new(ErrorKind::Other,"parse failed"))
     };
 
     let addr = match addr {
@@ -42,21 +42,22 @@ fn parse_proxy_protocol(mut buf : &[u8]) -> Result<(SocketAddrV4 , &[u8]), Error
     Ok((addr , buf))
 }
 
-pub async fn forward_mmproxy(bind_addr: &str, local_port: u32, remote_host: &str, remote_port: u32 , rt : &Runtime){
+pub async fn forward_mmproxy(bind_addr: &str, local_port: u16, remote_host: &str, remote_port: u16 , rt : &Runtime){
     let remote_addr : SocketAddr = format!("{}:{}", remote_host, remote_port).parse().unwrap();
     let local_addr = format!("{}:{}", bind_addr, local_port);
-    let local_socket = match UdpBuilder::new_v4().unwrap()
-        .reuse_address(true).unwrap()
-        .reuse_port(true).unwrap()
-        .bind(local_addr.clone()) {
-            Ok(p) => p,
-            Err(_) => {
-                log::error!("listen to {} faild!" , local_addr);
-                return;
-            },
-        };
-    local_socket.set_nonblocking(true).unwrap();
-    let local_socket = UdpSocket::from_std(local_socket).unwrap();
+    let local_socket: UdpSocket = match UdpSocket::bind(local_addr.clone()).await {
+        Ok(s) => s,
+        Err(e) => {
+            log::error!("failed to bind to {} - error: {}", local_addr, e);
+            return;
+        }
+    };
+
+    let sock_ref = SockRef::from(&local_socket);
+    sock_ref.set_reuse_address(true).unwrap();
+    sock_ref.set_reuse_port(true).unwrap();
+    sock_ref.set_nonblocking(true).unwrap();
+    
     log::info!("listen mmproxy to {}" , local_addr);
 
     let ( c_send , mut c_recv) = unbounded_channel::<(SocketAddr, Vec<u8>)>();
@@ -91,7 +92,7 @@ pub async fn forward_mmproxy(bind_addr: &str, local_port: u32, remote_host: &str
                 let (real_addr , buf) = match parse_proxy_protocol(buf){
                     Ok(p) => p,
                     Err(_) => {
-                        log::error!("parse protocol proxy faild from : [{}:{}] " , src_addr.ip().to_string() , src_addr.port());
+                        log::error!("parse protocol proxy failed from : [{}:{}] " , src_addr.ip().to_string() , src_addr.port());
                         continue;
                     },
                 };
-- 
2.51.2

